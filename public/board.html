<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Pool Cue</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #111111;
            --bg-secondary: #1a1a1a;
            --text-primary: #f2f2f2;
            --text-secondary: #888888;
            --text-muted: #555555;
            --accent: #f5c518;
            --success: #22c55e;
            --danger: #ef4444;
            --border: rgba(255,255,255,0.08);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; user-select: none; }
        html, body { height: 100%; overflow: hidden; background: var(--bg-secondary); }
        body { font-family: 'Inter', -apple-system, sans-serif; display: flex; justify-content: center; align-items: center; padding: 10px; }

        /* Wooden Frame */
        .frame {
            width: 100%;
            max-width: 620px;
            height: 100vh;
            max-height: 96vh;
            background: linear-gradient(165deg, #5d4037 0%, #4e342e 30%, #3e2723 70%, #2d1f1a 100%);
            border-radius: 6px;
            padding: 14px;
            box-shadow:
                inset 2px 2px 4px rgba(255,255,255,0.1),
                inset -2px -2px 4px rgba(0,0,0,0.3),
                0 8px 32px rgba(0,0,0,0.6),
                0 2px 8px rgba(0,0,0,0.4);
            position: relative;
        }
        .frame::before {
            content: '';
            position: absolute;
            top: 10px; left: 10px; right: 10px; bottom: 10px;
            border: 2px solid rgba(0,0,0,0.3);
            border-radius: 4px;
            pointer-events: none;
        }

        .board {
            width: 100%; height: 100%;
            background: #0c0c0c;
            border-radius: 4px;
            display: flex; flex-direction: column;
            overflow: hidden;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
        }
        #board-content {
            display: flex; flex-direction: column;
            flex: 1; min-height: 0;
        }

        /* Header */
        .header {
            display: flex; justify-content: space-between; align-items: flex-start;
            padding: 12px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.06);
        }
        .shot-caller-section { flex: 1; }
        .meta { font-size: 0.65rem; color: #666; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; }
        .shot-caller-name { font-size: 2rem; font-weight: 700; color: #fff; letter-spacing: -0.03em; line-height: 1.1; transition: opacity 0.2s; }
        .shot-caller-name.flash { animation: nameFlash 0.5s ease-out; }
        @keyframes nameFlash {
            0% { opacity: 0; transform: scale(0.95); }
            100% { opacity: 1; transform: scale(1); }
        }
        .shot-caller-name.empty { font-size: 1.3rem; color: #444; font-weight: 500; }
        .win-streak { display: flex; align-items: baseline; gap: 6px; margin-top: 4px; }
        .win-count { font-size: 1.2rem; font-weight: 700; color: #e5a147; }
        .win-label { font-size: 0.7rem; color: #666; }
        .win-streak.hot .win-count { color: #f97316; }
        .win-streak.on-fire .win-count { color: #ef4444; text-shadow: 0 0 12px rgba(239,68,68,0.5); }
        .win-streak.on-fire .win-label { color: #ef4444; }
        .win-streak.legendary .win-count { color: #f5c518; text-shadow: 0 0 16px rgba(245,197,24,0.6); font-size: 1.4rem; }
        .win-streak.legendary .win-label { color: #f5c518; }
        .rules { display: flex; gap: 6px; margin-top: 8px; }
        .rule-tag { padding: 4px 10px; background: #1a1a1a; border-radius: 4px; font-size: 0.7rem; color: #888; font-weight: 500; }
        .qr-section { text-align: center; flex-shrink: 0; }
        .qr-box { background: #fff; padding: 10px; border-radius: 8px; }
        .qr-code { width: 130px; height: 130px; display: block; }
        .neon-svg { display: block; margin: 6px auto 0; width: 170px; height: 55px; }
        @keyframes neonFlicker {
            0%,89%,91%,93%,95%,100% { opacity: 1; }
            90% { opacity: 0.65; }
            92% { opacity: 0.8; }
            94% { opacity: 0.7; }
        }
        .neon-group { animation: neonFlicker 6s ease-in-out infinite; }

        /* Main Content - Natural column flow: top-to-bottom, then next column */
        .main {
            display: flex;
            flex-direction: column;
            flex-wrap: wrap;
            row-gap: 6px;
            column-gap: 10px;
            overflow: hidden;
            flex: 1;
            padding: 6px 16px;
            align-content: flex-start;
        }
        .queue-col {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .queue-label {
            font-size: 0.75rem; font-weight: 600; color: #555;
            text-transform: uppercase; letter-spacing: 1px;
            margin-bottom: 6px;
        }

        /* Challenger Card */
        .challenger-card {
            background: #1a1a1a;
            border: 1px solid rgba(239,68,68,0.3);
            border-radius: 5px;
            padding: 8px 12px;
            animation: slideIn 0.3s ease-out;
            width: calc(50% - 5px);
        }
        .challenger-card .name-row { display: flex; align-items: center; gap: 8px; }
        .challenger-card .pos { font-size: 0.9rem; color: #ef4444; min-width: 20px; font-weight: 500; }
        .challenger-card .name { font-size: 1rem; font-weight: 600; color: #fff; }
        .challenger-card .hint { font-size: 0.6rem; color: #444; margin-top: 2px; margin-left: 28px; }
        .hint { font-size: 0.7rem; color: #444; }

        /* Swipe states */
        .shot-caller-section.swiping { transition: none; }
        .shot-caller-section.swipe-left { background: rgba(239,68,68,0.1); }
        .shot-caller-section.swipe-right { background: rgba(34,197,94,0.1); }
        .challenger-card.swiping { cursor: grabbing; }
        .challenger-card.swipe-left, .challenger-card.swipe-right { background: rgba(239,68,68,0.2); border-color: rgba(239,68,68,0.4); }

        /* Queue Items */
        .queue-item {
            display: flex; align-items: center; gap: 10px;
            padding: 10px 12px;
            background: #141414;
            border-radius: 5px;
            animation: slideIn 0.3s ease-out;
            width: calc(50% - 5px);
        }
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .queue-item .pos { font-size: 0.9rem; color: #444; min-width: 20px; font-weight: 500; }
        .queue-item .name { font-size: 0.95rem; color: #aaa; flex: 1; }
        .queue-item .confirm-status { font-size: 0.75rem; opacity: 0.9; padding: 2px 6px; border-radius: 4px; }
        .queue-item .confirm-status.confirmed { color: #22c55e; background: rgba(34,197,94,0.15); }
        .queue-item.needs-confirm { border-left: 2px solid #eab308; }
        .queue-item.needs-confirm .confirm-status { color: #eab308; background: rgba(234,179,8,0.15); }
        .queue-item.mia { border-left: 2px solid #f97316; }
        .queue-item.mia .confirm-status { color: #f97316; background: rgba(249,115,22,0.15); }
        .queue-item.ghosted { border-left: 2px solid #ef4444; }
        .queue-item.ghosted .confirm-status { color: #ef4444; background: rgba(239,68,68,0.15); }

        /* Footer */
        .footer {
            height: 50px;
            background: #0a0a0a;
            border-top: 1px solid rgba(255,255,255,0.06);
            position: relative;
            display: flex; align-items: center; justify-content: center;
        }
        .footer-brand {
            font-size: 0.6rem; color: #333;
            text-transform: uppercase; letter-spacing: 2px; font-weight: 600;
        }
        .footer-btn {
            position: absolute; bottom: 12px;
            padding: 6px 14px;
            background: transparent;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 4px;
            color: #555;
            font-size: 0.7rem;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.15s;
        }
        .footer-btn:hover { border-color: #fff; color: #fff; }
        .footer-btn.disabled { opacity: 0.3; cursor: default; }
        .undo-btn { left: 12px; }
        .fullscreen-btn { right: 12px; }

        /* Confirm Dialog */
        .confirm-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 100; justify-content: center; align-items: center; }
        .confirm-overlay.show { display: flex; }
        .confirm-box { background: #1a1a1a; border: 1px solid rgba(255,255,255,0.1); padding: 24px 32px; border-radius: 12px; text-align: center; }
        .confirm-box p { font-size: 1.1rem; color: #fff; margin-bottom: 20px; }
        .confirm-buttons { display: flex; gap: 12px; justify-content: center; }
        .confirm-buttons button { padding: 12px 28px; border: none; border-radius: 6px; font-family: inherit; font-size: 0.9rem; font-weight: 500; cursor: pointer; }
        .confirm-yes { background: #fff; color: #0c0c0c; }
        .confirm-no { background: transparent; border: 1px solid rgba(255,255,255,0.2); color: #888; }

        /* Empty/Closed states */
        .state-screen {
            display: none; flex: 1; align-items: center; justify-content: center;
            flex-direction: column; text-align: center; gap: 12px;
        }
        .state-screen.active { display: flex; }
        .state-screen .icon { font-size: 3rem; }
        .state-screen h2 { font-size: 1.3rem; font-weight: 600; color: #888; }
        .state-screen p { color: #555; font-size: 0.85rem; }

        /* Welcome splash (no session / idle board) */
        .welcome-screen {
            display: none; flex: 1; align-items: center; justify-content: center;
            flex-direction: column; text-align: center; gap: 0;
            padding: 20px;
        }
        .welcome-screen.active { display: flex; }
        .welcome-brand {
            font-size: 0.75rem; font-weight: 600; color: #555;
            text-transform: uppercase; letter-spacing: 3px; margin-bottom: 6px;
        }
        .welcome-headline {
            font-size: 2.4rem; font-weight: 700; color: #fff;
            letter-spacing: -0.02em; line-height: 1.1; margin-bottom: 6px;
        }
        .welcome-sub {
            font-size: 0.9rem; color: #666; margin-bottom: 24px;
        }
        .welcome-qr-wrap {
            background: #fff; padding: 16px; border-radius: 12px;
            box-shadow: 0 0 40px rgba(245,197,24,0.08), 0 4px 20px rgba(0,0,0,0.4);
            margin-bottom: 16px;
        }
        .welcome-qr-wrap img { width: 180px; height: 180px; display: block; }
        .welcome-cta {
            font-size: 0.8rem; font-weight: 500; color: #f5c518;
            text-transform: uppercase; letter-spacing: 2px;
            animation: pulse-glow 2.5s ease-in-out infinite;
        }
        @keyframes pulse-glow {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
        .welcome-footer {
            position: absolute; bottom: 16px;
            font-size: 0.6rem; color: #333; letter-spacing: 1px;
        }

        /* Kiosk start overlay */
        .kiosk-overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.95); z-index: 200;
            justify-content: center; align-items: center;
            flex-direction: column; text-align: center; gap: 16px; cursor: pointer;
        }
        .kiosk-overlay.show { display: flex; }
        .kiosk-overlay .kiosk-icon { font-size: 4rem; }
        .kiosk-overlay .kiosk-title { font-size: 1.8rem; font-weight: 700; color: #fff; }
        .kiosk-overlay .kiosk-sub { font-size: 1rem; color: #f5c518; animation: pulse-glow 2s ease-in-out infinite; }

        /* Kiosk layout ‚Äî fill the screen edge-to-edge */
        body.kiosk { padding: 0; }
        body.kiosk .frame {
            max-width: 100%;
            max-height: 100vh;
            height: 100vh;
            border-radius: 0;
            padding: 14px;
        }
        body.kiosk .frame::before { top: 8px; left: 8px; right: 8px; bottom: 8px; }
        body.kiosk .board { border-radius: 0; }

        /* Debug panel */
        .debug-panel {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: #111; border-top: 2px solid #f5c518;
            padding: 10px 16px; display: none; z-index: 50;
            gap: 8px; flex-wrap: wrap; align-items: center;
        }
        .debug-panel.show { display: flex; }
        .debug-panel button {
            padding: 8px 14px; border: 1px solid #333; border-radius: 6px;
            background: #1a1a1a; color: #fff; font-size: 0.75rem;
            font-family: inherit; font-weight: 600; cursor: pointer;
        }
        .debug-panel button:active { background: #333; }
        .debug-panel .debug-label {
            font-size: 0.65rem; color: #f5c518; font-weight: 700;
            text-transform: uppercase; letter-spacing: 1px;
        }
    </style>
</head>
<body>
    <div class="frame">
    <div class="board">
        <div id="board-content">
            <!-- Header: shot caller + QR -->
            <div class="header">
                <div class="shot-caller-section swipeable" id="kingSection" data-role="king">
                    <div class="meta" id="avgTimeLabel"></div>
                    <div class="meta">Shot Caller</div>
                    <div class="shot-caller-name" id="kingName">Table Open</div>
                    <div class="win-streak" id="winStreak" style="display:none;">
                        <span class="win-count" id="winCount">0</span>
                        <span class="win-label">wins</span>
                    </div>
                    <div class="hint" id="kingHint" style="display:none;">‚Üê swipe if lost ‚Üí</div>
                    <div class="rules" id="rulesDisplay">
                        <span class="rule-tag" id="tagGameType">Singles</span>
                        <span class="rule-tag" id="tagRuleType">Bar Rules</span>
                    </div>
                </div>
                <div class="qr-section">
                    <div class="qr-box">
                        <img id="qrImg" src="" class="qr-code" alt="QR">
                    </div>
                    <svg class="neon-svg" viewBox="0 0 170 55" xmlns="http://www.w3.org/2000/svg">
                        <defs>
                            <filter id="gW"><feGaussianBlur stdDeviation="5"/></filter>
                            <filter id="gM"><feGaussianBlur stdDeviation="2.5"/></filter>
                            <filter id="gT"><feGaussianBlur stdDeviation="1"/></filter>
                        </defs>
                        <g class="neon-group">
                            <!-- Text: JOIN LIST ‚Äî layer: wide glow, mid glow, tight glow, tube, core -->
                            <text x="75" y="30" text-anchor="middle" font-family="Inter,sans-serif" font-weight="800" font-size="24" letter-spacing="2"
                                fill="none" stroke="#ff4400" stroke-width="7" filter="url(#gW)" opacity="0.3">JOIN LIST</text>
                            <text x="75" y="30" text-anchor="middle" font-family="Inter,sans-serif" font-weight="800" font-size="24" letter-spacing="2"
                                fill="none" stroke="#ff5500" stroke-width="4" filter="url(#gM)" opacity="0.55">JOIN LIST</text>
                            <text x="75" y="30" text-anchor="middle" font-family="Inter,sans-serif" font-weight="800" font-size="24" letter-spacing="2"
                                fill="none" stroke="#ff7733" stroke-width="2.5" filter="url(#gT)" opacity="0.75">JOIN LIST</text>
                            <text x="75" y="30" text-anchor="middle" font-family="Inter,sans-serif" font-weight="800" font-size="24" letter-spacing="2"
                                fill="none" stroke="#ffaa66" stroke-width="1.5">JOIN LIST</text>
                            <text x="75" y="30" text-anchor="middle" font-family="Inter,sans-serif" font-weight="800" font-size="24" letter-spacing="2"
                                fill="#ffe0c0">JOIN LIST</text>

                            <!-- Arrow line: underline going right, curves up, arrowhead pointing up -->
                            <!-- The path: horizontal under text ‚Üí curve up ‚Üí vertical up -->
                            <path d="M8,40 L138,40 Q152,40 152,26 L152,10" fill="none" stroke="#ff4400" stroke-width="6" stroke-linecap="round" stroke-linejoin="round" filter="url(#gW)" opacity="0.3"/>
                            <path d="M8,40 L138,40 Q152,40 152,26 L152,10" fill="none" stroke="#ff5500" stroke-width="3.5" stroke-linecap="round" stroke-linejoin="round" filter="url(#gM)" opacity="0.55"/>
                            <path d="M8,40 L138,40 Q152,40 152,26 L152,10" fill="none" stroke="#ff7733" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" filter="url(#gT)" opacity="0.75"/>
                            <path d="M8,40 L138,40 Q152,40 152,26 L152,10" fill="none" stroke="#ffaa66" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M8,40 L138,40 Q152,40 152,26 L152,10" fill="none" stroke="#ffe0c0" stroke-width="0.6" stroke-linecap="round" stroke-linejoin="round"/>

                            <!-- Arrowhead at top -->
                            <polyline points="145,16 152,4 159,16" fill="none" stroke="#ff4400" stroke-width="6" stroke-linecap="round" stroke-linejoin="round" filter="url(#gW)" opacity="0.3"/>
                            <polyline points="145,16 152,4 159,16" fill="none" stroke="#ff5500" stroke-width="3.5" stroke-linecap="round" stroke-linejoin="round" filter="url(#gM)" opacity="0.55"/>
                            <polyline points="145,16 152,4 159,16" fill="none" stroke="#ff7733" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" filter="url(#gT)" opacity="0.75"/>
                            <polyline points="145,16 152,4 159,16" fill="none" stroke="#ffaa66" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
                            <polyline points="145,16 152,4 159,16" fill="none" stroke="#ffe0c0" stroke-width="0.6" stroke-linecap="round" stroke-linejoin="round"/>
                        </g>
                    </svg>
                </div>
            </div>

            <!-- Main queue area -->
            <div class="main" id="mainContent"></div>

            <!-- Empty state (shown when session active but no players) -->
            <div class="state-screen" id="stateEmpty">
                <div class="welcome-brand">Table Open</div>
                <div style="font-size:1.8rem;font-weight:700;color:#fff;margin-bottom:4px;">First Up?</div>
                <div style="font-size:0.85rem;color:#666;margin-bottom:20px;">Scan to put your name on the board</div>
                <div class="welcome-qr-wrap">
                    <img id="emptyQrImg" src="" style="width:160px;height:160px;display:block;" alt="QR">
                </div>
                <div class="welcome-cta">Scan with your phone's camera</div>
            </div>

            <!-- Welcome / Idle state (no session or closed) -->
            <div class="welcome-screen" id="stateWelcome">
                <div class="welcome-brand">Pool Cue</div>
                <div class="welcome-headline">Got Next?</div>
                <div class="welcome-sub">Scan to put your name up</div>
                <div class="welcome-qr-wrap">
                    <img id="welcomeQrImg" src="" class="qr-code" alt="QR" style="width:180px;height:180px;">
                </div>
                <div class="welcome-cta">Scan with your phone's camera</div>
            </div>
        </div>

        <div class="footer">
            <button class="footer-btn undo-btn" id="undoBtn" onclick="doUndo()">‚Ü© Undo</button>
            <span class="footer-brand">Pool Cue</span>
            <button class="footer-btn fullscreen-btn" id="fsBtn" onclick="toggleFullscreen()">‚õ∂ Fullscreen</button>
        </div>
    </div>
    </div>

    <!-- Confirm overlay -->
    <div class="confirm-overlay" id="confirmOverlay">
        <div class="confirm-box">
            <p id="confirmMessage">Remove player?</p>
            <div class="confirm-buttons">
                <button class="confirm-no" onclick="hideConfirm()">Cancel</button>
                <button class="confirm-yes" onclick="executeConfirm()">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Kiosk fullscreen overlay -->
    <div class="kiosk-overlay" id="kioskOverlay" onclick="launchKiosk()">
        <div class="kiosk-icon">üé±</div>
        <div class="kiosk-title">Pool Cue</div>
        <div class="kiosk-sub">Tap anywhere to start</div>
    </div>

    <!-- Debug panel -->
    <div class="debug-panel" id="debugPanel">
        <span class="debug-label">Debug</span>
        <button onclick="debugAddPlayer()">+ Player</button>
        <button onclick="debugAdd3()">+ 3 Players</button>
        <button onclick="debugSimResult('king-wins')">King Wins</button>
        <button onclick="debugSimResult('challenger-wins')">Challenger Wins</button>
        <button onclick="debugReset()">Reset Queue</button>
        <button onclick="document.getElementById('debugPanel').classList.remove('show')" style="margin-left:auto;background:#611;color:#faa;">‚úï Close</button>
    </div>

    <script>
    const TABLE_CODE = window.location.pathname.split('/').pop();
    let ws = null;
    let queue = [];
    let session = null;
    let avgGameSeconds = null;
    let pendingAction = null;
    let lastKingName = '';

    // Undo is always available ‚Äî server validates the 60-second window

    // XSS protection
    function esc(str) {
      if (!str) return '';
      const d = document.createElement('div');
      d.textContent = str;
      return d.innerHTML;
    }

    // QR code
    document.getElementById('qrImg').src = `/qr/${TABLE_CODE}`;
    document.getElementById('welcomeQrImg').src = `/qr/${TABLE_CODE}`;
    document.getElementById('emptyQrImg').src = `/qr/${TABLE_CODE}`;

    // ============================================
    // WebSocket
    // ============================================
    function connectWS() {
        const proto = location.protocol === 'https:' ? 'wss' : 'ws';
        ws = new WebSocket(`${proto}://${location.host}/ws?table=${encodeURIComponent(TABLE_CODE)}`);
        ws.onmessage = (e) => {
            let data;
            try { data = JSON.parse(e.data); } catch { return; }
            if (data.type === 'queue_update') {
                queue = data.queue;
                session = data.session;
                avgGameSeconds = data.avg_game_seconds;
                render();
            } else if (data.type === 'session_closed') {
                session = { status: 'closed' };
                queue = [];
                render();
            }
        };
        ws.onopen = () => {
            // Re-fetch full state on reconnect (covers any missed updates)
            fetch(`/api/queue/${TABLE_CODE}`).then(r => r.json()).then(data => {
                queue = data.queue || [];
                session = data.session;
                avgGameSeconds = data.avg_game_seconds;
                render();
            }).catch(() => {});
        };
        ws.onclose = () => setTimeout(connectWS, 2000);
        ws.onerror = () => ws.close();
    }

    async function init() {
        try {
            const res = await fetch(`/api/queue/${TABLE_CODE}`);
            const data = await res.json();
            queue = data.queue || [];
            session = data.session;
            avgGameSeconds = data.avg_game_seconds;
            render();
        } catch (err) {
            console.error('Init fetch failed:', err);
        }
        connectWS();
    }

    // ============================================
    // Render
    // ============================================
    function render() {
        const mainEl = document.getElementById('mainContent');
        const stateEmpty = document.getElementById('stateEmpty');
        const stateWelcome = document.getElementById('stateWelcome');
        const headerEl = document.querySelector('.header');
        const footerEl = document.querySelector('.footer');

        // No session or closed ‚Äî show welcome splash with QR
        if (!session || session.status === 'closed') {
            headerEl.style.display = 'none';
            mainEl.style.display = 'none';
            footerEl.style.display = 'none';
            stateEmpty.classList.remove('active');
            stateWelcome.classList.add('active');
            return;
        }
        stateWelcome.classList.remove('active');

        // Empty queue
        if (queue.length === 0) {
            headerEl.style.display = 'flex';
            mainEl.style.display = 'none';
            footerEl.style.display = 'flex';
            stateEmpty.classList.add('active');
            // Reset header to empty state
            document.getElementById('kingName').textContent = 'Table Open';
            document.getElementById('kingName').className = 'shot-caller-name empty';
            document.getElementById('winStreak').style.display = 'none';
            document.getElementById('kingHint').style.display = 'none';
            renderRules();
            return;
        }

        stateEmpty.classList.remove('active');
        headerEl.style.display = 'flex';
        mainEl.style.display = 'flex';
        footerEl.style.display = 'flex';

        // King (position 1)
        const king = queue.find(e => e.position === 1);
        const kingNameEl = document.getElementById('kingName');
        const winStreakEl = document.getElementById('winStreak');
        const kingHintEl = document.getElementById('kingHint');

        if (king) {
            const partnerStr = king.partner_name ? ` & ${king.partner_name}` : '';
            const fullName = king.player_name + partnerStr;
            kingNameEl.textContent = fullName;
            kingNameEl.className = 'shot-caller-name';
            // Flash animation on new king
            if (fullName !== lastKingName && lastKingName !== '') {
                kingNameEl.classList.add('flash');
                setTimeout(() => kingNameEl.classList.remove('flash'), 600);
            }
            lastKingName = fullName;
            if (king.win_streak > 0) {
                winStreakEl.style.display = 'flex';
                document.getElementById('winCount').textContent = king.win_streak;
                // Streak flair tiers
                const streak = king.win_streak;
                winStreakEl.className = 'win-streak';
                let streakEmoji = 'üî•';
                let streakLabel = 'wins';
                if (streak >= 7) {
                    winStreakEl.classList.add('legendary');
                    streakEmoji = 'üëë';
                    streakLabel = 'win streak ‚Äî LEGENDARY';
                } else if (streak >= 5) {
                    winStreakEl.classList.add('on-fire');
                    streakEmoji = 'üî•';
                    streakLabel = 'win streak ‚Äî ON FIRE';
                } else if (streak >= 3) {
                    winStreakEl.classList.add('hot');
                    streakEmoji = 'üî•';
                    streakLabel = 'win streak ‚Äî heating up';
                }
                document.getElementById('winCount').textContent = `${streakEmoji} ${streak}`;
                document.querySelector('.win-label').textContent = streakLabel;
            } else {
                winStreakEl.style.display = 'none';
            }
            kingHintEl.style.display = queue.some(e => e.position === 2) ? 'block' : 'none';
        } else {
            kingNameEl.textContent = 'Table Open';
            kingNameEl.className = 'shot-caller-name empty';
            winStreakEl.style.display = 'none';
            kingHintEl.style.display = 'none';
        }

        // Avg game time
        const avgLabel = document.getElementById('avgTimeLabel');
        if (avgGameSeconds && avgGameSeconds > 0) {
            avgLabel.textContent = `~${Math.round(avgGameSeconds / 60)}m avg`;
        } else {
            avgLabel.textContent = '';
        }

        // Rules tags
        renderRules();

        // Main content: challenger + queue
        const challenger = queue.find(e => e.position === 2);
        const waiting = queue.filter(e => e.position >= 3).sort((a, b) => a.position - b.position || a.id - b.id);
        const displayWaiting = waiting;

        // Challenger card (first item in column 1)
        let challengerHtml = '';
        if (challenger) {
            const partnerStr = challenger.partner_name ? ` & ${esc(challenger.partner_name)}` : '';
            let chalStatusHtml = '';
            if (challenger.status === 'confirmed') {
                chalStatusHtml = '<span class="confirm-status confirmed">‚úì Here</span>';
            } else if (challenger.status === 'ghosted') {
                chalStatusHtml = '<span class="confirm-status" style="color:#ef4444;background:rgba(239,68,68,0.15)">üî¥ Probably left</span>';
            } else if (challenger.status === 'mia') {
                chalStatusHtml = '<span class="confirm-status" style="color:#f97316;background:rgba(249,115,22,0.15)">üü† MIA</span>';
            } else if (challenger.confirmation_sent_at) {
                chalStatusHtml = '<span class="confirm-status">üü° Waiting</span>';
            }
            challengerHtml = `<div class="challenger-card swipeable" data-role="challenger">
                <div class="name-row">
                    <span class="pos">2</span>
                    <span class="name">${esc(challenger.player_name)}${partnerStr}</span>
                    ${chalStatusHtml}
                </div>
                ${queue.some(e => e.position === 2) ? '<div class="hint">‚Üê swipe if lost ‚Üí</div>' : ''}
            </div>`;
        }

        // Queue items (capped at MAX_DISPLAY)
        const queueItems = [];
        for (const entry of displayWaiting) {
            const isGhosted = entry.status === 'ghosted';
            const isMia = entry.status === 'mia';
            const needsConfirm = entry.confirmation_sent_at && entry.status === 'waiting';
            let classes = 'queue-item';
            if (isGhosted) classes += ' ghosted';
            else if (isMia) classes += ' mia';
            else if (needsConfirm) classes += ' needs-confirm';

            let confirmHtml = '';
            if (entry.status === 'confirmed') {
                confirmHtml = '<span class="confirm-status confirmed">‚úì Here</span>';
            } else if (isGhosted) {
                confirmHtml = '<span class="confirm-status" style="color:#ef4444;background:rgba(239,68,68,0.15)">üî¥ Probably left</span>';
            } else if (isMia) {
                confirmHtml = '<span class="confirm-status" style="color:#f97316;background:rgba(249,115,22,0.15)">üü† MIA</span>';
            } else if (needsConfirm) {
                confirmHtml = '<span class="confirm-status">üü° Waiting</span>';
            }

            const partnerStr = entry.partner_name ? ` & ${esc(entry.partner_name)}` : '';
            queueItems.push(`<div class="${classes}">
                <span class="pos">${entry.position}</span>
                <span class="name">${esc(entry.player_name)}${partnerStr}</span>
                ${confirmHtml}
            </div>`);
        }

        // Output all items sequentially - CSS flex-wrap handles the two columns
        const html = challengerHtml + queueItems.join('');

        // Only update DOM if content actually changed (prevents blink)
        if (mainEl.dataset.lastHtml !== html) {
            mainEl.innerHTML = html;
            mainEl.dataset.lastHtml = html;
            // Re-attach swipe handlers only to new challenger card (not king header)
            attachSwipeHandlers(mainEl);

            // Fill remaining space with empty placeholder slots (like empty chalkboard lines)
            // Also trim any items that overflow the container and show "+X more"
            requestAnimationFrame(() => {
                const allItems = Array.from(mainEl.querySelectorAll('.queue-item, .challenger-card'));
                if (allItems.length === 0) return;
                const mainRect = mainEl.getBoundingClientRect();
                const itemHeight = allItems[0].offsetHeight + 6;

                // Remove items that overflow the container (off-screen right or below)
                let hiddenCount = 0;
                for (let i = allItems.length - 1; i >= 0; i--) {
                    const rect = allItems[i].getBoundingClientRect();
                    if (rect.right > mainRect.right || rect.bottom > mainRect.bottom) {
                        allItems[i].remove();
                        hiddenCount++;
                    }
                }

                // Show "+X more" if items were hidden
                if (hiddenCount > 0) {
                    // Remove last visible item in column 2 to make room
                    const remaining = Array.from(mainEl.querySelectorAll('.queue-item, .challenger-card'));
                    const lastItem = remaining[remaining.length - 1];
                    if (lastItem) { lastItem.remove(); hiddenCount++; }
                    const overflow = document.createElement('div');
                    overflow.className = 'queue-item';
                    overflow.style.cssText = 'text-align:center;color:#888;font-style:italic;font-size:0.85rem;justify-content:center;';
                    overflow.textContent = `+${hiddenCount} more`;
                    mainEl.appendChild(overflow);
                    return; // board is full, no placeholders needed
                }

                // Fill remaining space with placeholder slots
                let nextPos = displayWaiting.length + (challenger ? 3 : 2);
                let safety = 0;
                while (safety < 100) {
                    const lastItem = mainEl.lastElementChild;
                    if (!lastItem) break;
                    if (mainRect.bottom - lastItem.getBoundingClientRect().bottom < itemHeight) break;
                    const placeholder = document.createElement('div');
                    placeholder.className = 'queue-item';
                    placeholder.style.opacity = '0.15';
                    placeholder.innerHTML = `<span class="pos">${nextPos}</span><span class="name">‚Äî</span>`;
                    mainEl.appendChild(placeholder);
                    nextPos++;
                    safety++;
                }
            });
        }
    }

    function renderRules() {
        if (!session) return;
        const gt = session.game_type === 'doubles' ? 'Doubles' : 'Singles';
        const rt = session.rule_type === 'apa' ? 'APA' : session.rule_type === 'bca' ? 'BCA' : 'Bar Rules';
        document.getElementById('tagGameType').textContent = gt;
        document.getElementById('tagRuleType').textContent = rt;
    }

    // ============================================
    // Swipe handling (matches old version exactly)
    // ============================================
    let startX, currentEl;
    const THRESHOLD = 60;

    function attachSwipeHandlers(container) {
        const root = container || document;
        root.querySelectorAll('.swipeable').forEach(el => {
            // Touch events
            el.addEventListener('touchstart', e => {
                startX = e.touches[0].clientX;
                currentEl = e.currentTarget;
                currentEl.classList.add('swiping');
            }, { passive: true });

            el.addEventListener('touchmove', e => {
                if (!currentEl) return;
                e.preventDefault();
                const diffX = e.touches[0].clientX - startX;
                currentEl.style.transform = `translateX(${diffX}px)`;
                currentEl.style.opacity = Math.max(0.4, 1 - Math.abs(diffX) / 250);
                currentEl.classList.toggle('swipe-left', diffX < -30);
                currentEl.classList.toggle('swipe-right', diffX > 30);
            }, { passive: false });

            el.addEventListener('touchend', e => {
                if (!currentEl) return;
                handleSwipe(e.changedTouches[0].clientX - startX);
            });

            // Mouse events (for desktop testing)
            el.addEventListener('mousedown', e => {
                startX = e.clientX;
                currentEl = e.currentTarget;
                currentEl.classList.add('swiping');
                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            });
        });
    }

    function onMouseMove(e) {
        if (!currentEl) return;
        const diffX = e.clientX - startX;
        currentEl.style.transform = `translateX(${diffX}px)`;
        currentEl.style.opacity = Math.max(0.4, 1 - Math.abs(diffX) / 250);
        currentEl.classList.toggle('swipe-left', diffX < -30);
        currentEl.classList.toggle('swipe-right', diffX > 30);
    }

    function onMouseUp(e) {
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onMouseUp);
        if (currentEl) handleSwipe(e.clientX - startX);
    }

    function handleSwipe(diffX) {
        if (!currentEl) return;
        currentEl.classList.remove('swiping', 'swipe-left', 'swipe-right');

        if (Math.abs(diffX) > THRESHOLD) {
            const role = currentEl.dataset.role;
            // Swiping king off = challenger wins, swiping challenger off = king wins
            const result = role === 'challenger' ? 'king-wins' : 'challenger-wins';
            const loserName = role === 'challenger'
                ? (queue.find(e => e.position === 2)?.player_name || '?')
                : (queue.find(e => e.position === 1)?.player_name || '?');

            // Animate off screen
            currentEl.style.transform = `translateX(${diffX < 0 ? '-100vw' : '100vw'})`;
            currentEl.style.opacity = '0';

            // Show confirm
            pendingAction = { type: 'result', result };
            document.getElementById('confirmMessage').textContent = `Remove ${loserName}?`;
            document.getElementById('confirmOverlay').classList.add('show');
        } else {
            // Snap back
            currentEl.style.transform = '';
            currentEl.style.opacity = '';
        }
        currentEl = null;
    }

    function hideConfirm() {
        document.getElementById('confirmOverlay').classList.remove('show');
        pendingAction = null;
        // Reset king section inline styles from swipe animation
        const kingEl = document.getElementById('kingSection');
        kingEl.style.transform = '';
        kingEl.style.opacity = '';
        kingEl.classList.remove('swiping', 'swipe-left', 'swipe-right');
        render();
    }

    async function executeConfirm() {
        document.getElementById('confirmOverlay').classList.remove('show');
        if (!pendingAction) return;

        if (pendingAction.type === 'result') {
            try {
                await fetch('/api/result', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tableCode: TABLE_CODE, result: pendingAction.result })
                });
            } catch (err) {
                console.error('Result API error:', err);
            }
        } else if (pendingAction.type === 'undo') {
            try {
                const res = await fetch('/api/undo', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tableCode: TABLE_CODE, source: 'board' })
                });
                const data = await res.json();
                if (data.error) console.log('Undo rejected:', data.error);
            } catch (err) {
                console.error('Undo API error:', err);
            }
        }
        pendingAction = null;
        // Reset king section inline styles from swipe animation
        const kingEl = document.getElementById('kingSection');
        kingEl.style.transform = '';
        kingEl.style.opacity = '';
        kingEl.classList.remove('swiping', 'swipe-left', 'swipe-right');
        // Force immediate re-render: fetch fresh state so board never shows
        // stale/blank content while waiting for WebSocket update
        try {
            const fresh = await fetch(`/api/queue/${TABLE_CODE}`).then(r => r.json());
            queue = fresh.queue || [];
            session = fresh.session;
            avgGameSeconds = fresh.avg_game_seconds;
            render();
        } catch(e) {}
    }

    function doUndo() {
        pendingAction = { type: 'undo' };
        document.getElementById('confirmMessage').textContent = 'Undo last removal?';
        document.getElementById('confirmOverlay').classList.add('show');
    }

    // Kiosk mode: show overlay if ?kiosk in URL
    if (window.location.search.includes('kiosk')) {
      document.getElementById('kioskOverlay').classList.add('show');
      document.body.classList.add('kiosk');
    }
    function launchKiosk() {
      document.getElementById('kioskOverlay').classList.remove('show');
      document.documentElement.requestFullscreen().catch(() => {});
      acquireWakeLock();
    }

    // Wake Lock ‚Äî keeps screen on in kiosk mode
    let wakeLock = null;
    async function acquireWakeLock() {
      if (!('wakeLock' in navigator)) return;
      try {
        wakeLock = await navigator.wakeLock.request('screen');
        wakeLock.addEventListener('release', () => { wakeLock = null; });
      } catch (_) {}
    }
    // Re-acquire when tab becomes visible (browser releases it on hide)
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible' && !wakeLock && window.location.search.includes('kiosk')) {
        acquireWakeLock();
      }
    });

    // Fullscreen toggle
    function toggleFullscreen() {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch(() => {});
        document.getElementById('fsBtn').textContent = '‚úï Exit';
      } else {
        document.exitFullscreen();
        document.getElementById('fsBtn').textContent = '‚õ∂ Fullscreen';
      }
    }
    document.addEventListener('fullscreenchange', () => {
      document.getElementById('fsBtn').textContent = document.fullscreenElement ? '‚úï Exit' : '‚õ∂ Fullscreen';
    });

    // Attach swipe to the king section in the header
    attachSwipeHandlers();

    // Hidden kiosk exit: tap top-left corner 5 times quickly
    let cornerTaps = 0;
    let cornerTimer = null;
    const cornerZone = document.createElement('div');
    cornerZone.style.cssText = 'position:fixed;top:0;left:0;width:40px;height:40px;z-index:9999;';
    document.body.appendChild(cornerZone);
    cornerZone.addEventListener('click', () => {
      cornerTaps++;
      clearTimeout(cornerTimer);
      if (cornerTaps >= 5) {
        cornerTaps = 0;
        if (confirm('Exit kiosk mode?')) window.close();
      }
      cornerTimer = setTimeout(() => { cornerTaps = 0; }, 2000);
    });

    // Debug mode: tap "Pool Cue" footer brand 5 times to toggle
    let debugTaps = 0;
    let debugTimer = null;
    document.querySelector('.footer-brand').addEventListener('click', () => {
      debugTaps++;
      clearTimeout(debugTimer);
      if (debugTaps >= 5) {
        debugTaps = 0;
        const panel = document.getElementById('debugPanel');
        panel.classList.toggle('show');
      }
      debugTimer = setTimeout(() => { debugTaps = 0; }, 2000);
    });

    async function debugAddPlayer() {
      try {
        await fetch('/api/debug/add-fake', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ tableCode: TABLE_CODE })
        });
      } catch (err) { console.error(err); }
    }
    async function debugAdd3() {
      await debugAddPlayer();
      await debugAddPlayer();
      await debugAddPlayer();
    }
    async function debugSimResult(result) {
      try {
        await fetch('/api/result', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ tableCode: TABLE_CODE, result })
        });
      } catch (err) { console.error(err); }
    }
    async function debugReset() {
      try {
        await fetch('/api/session/close', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ tableCode: TABLE_CODE, pin: '0000' })
        });
      } catch (err) { console.error(err); }
    }

    init();
    </script>
</body>
</html>
